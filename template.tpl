___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Cookie Handler",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Cookie Handler is a fully customizable, CMP v2-compliant cookie consent banner for GTM. Easily collect and manage user consent for analytics, ads, personalization, and functionality cookies.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "SELECT",
    "name": "command",
    "displayName": "Consent Command",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "default",
        "displayValue": "default"
      },
      {
        "value": "granted",
        "displayValue": "update"
      }
    ],
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "id",
    "displayName": "Cookie Handler ID",
    "simpleValueType": true,
    "notSetText": "Please enter the \u0027Domain Group ID\u0027 found on the Domains Page in Cookie Handler.",
    "valueHint": "Your Cookie Handler Domain Group ID",
    "valueValidators": [
      {
        "type": "NON_EMPTY",
        "errorMessage": "Please add a Domain Id from cookiehandler.io.",
        "enablingConditions": []
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "ad_storage",
    "displayName": "Ad Storage",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "granted",
        "displayValue": "granted"
      },
      {
        "value": "denied",
        "displayValue": "denied"
      },
      {
        "value": "not set",
        "displayValue": "notset"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "denied"
  },
  {
    "type": "SELECT",
    "name": "ad_user_data",
    "displayName": "Ad User Data",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "granted",
        "displayValue": "granted"
      },
      {
        "value": "denied",
        "displayValue": "denied"
      },
      {
        "value": "not set",
        "displayValue": "notset"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "denied"
  },
  {
    "type": "SELECT",
    "name": "ad_personalization",
    "displayName": "Ad Personalization",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "granted",
        "displayValue": "granted"
      },
      {
        "value": "denied",
        "displayValue": "denied"
      },
      {
        "value": "not set",
        "displayValue": "notset"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "denied"
  },
  {
    "type": "SELECT",
    "name": "personalization_storage",
    "displayName": "Personalization Storage",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "granted",
        "displayValue": "granted"
      },
      {
        "value": "denied",
        "displayValue": "denied"
      },
      {
        "value": "not set",
        "displayValue": "notset"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "denied"
  },
  {
    "type": "SELECT",
    "name": "functionality_storage",
    "displayName": "Functionality Storage",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "granted",
        "displayValue": "granted"
      },
      {
        "value": "denied",
        "displayValue": "denied"
      },
      {
        "value": "not set",
        "displayValue": "notset"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "granted"
  },
  {
    "type": "SELECT",
    "name": "analytics_storage",
    "displayName": "Analytics Storage",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "granted",
        "displayValue": "granted"
      },
      {
        "value": "denied",
        "displayValue": "denied"
      },
      {
        "value": "not set",
        "displayValue": "notset"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "denied"
  },
  {
    "type": "TEXT",
    "name": "event",
    "displayName": "dataLayer Event Name",
    "simpleValueType": true
  },
  {
    "type": "CHECKBOX",
    "name": "setDefaultConsent",
    "checkboxText": "Set Default Consent State",
    "simpleValueType": true,
    "defaultValue": true
  },
  {
    "type": "CHECKBOX",
    "name": "sendDataLayer",
    "checkboxText": "Push DataLayer Event",
    "simpleValueType": true,
    "defaultValue": true
  },
  {
    "type": "GROUP",
    "name": "additional_options",
    "displayName": "Additional Options",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "ads_data_redaction",
        "checkboxText": "Ads Data Redaction",
        "simpleValueType": true,
        "defaultValue": false
      },
      {
        "type": "CHECKBOX",
        "name": "url_passthrough",
        "checkboxText": "URL Passthrough",
        "simpleValueType": true,
        "defaultValue": false
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const dataLayerPush = require('createQueue')('dataLayer');
const setDefaultConsentState = require('setDefaultConsentState');
const updateConsentState = require('updateConsentState');
const gtagSet = require('gtagSet');
const log = require('logToConsole');
const injectScript = require('injectScript');
const setInWindow = require('setInWindow');
const getCookieValues = require('getCookieValues');
const JSON = require('JSON');
const decodeUriComponent = require('decodeUriComponent');

const consentFields = [
  'ad_storage',
  'analytics_storage',
  'personalization_storage',
  'functionality_storage',
  'ad_user_data',
  'ad_personalization'
];

const domainId = data.id;
const command = data.command || 'update';
const setDefaultConsent = data.setDefaultConsent !== false;
const consentCookie = getCookieValues('ch_cookie_consent', false)[0];


// 1. Always set the default consent state at the start
let defaultState = {};
consentFields.forEach(function(field) {
  defaultState[field] = (field === 'functionality_storage') ? 'granted' : 'denied';
});


if(setDefaultConsent && !consentCookie){
setDefaultConsentState(defaultState);
}

// 2. If the consent cookie exists, update Consent Mode with it
if (
  consentCookie &&
  typeof consentCookie === 'string' &&
  decodeUriComponent(consentCookie).charAt(0) === '{'
) {
  const parsed = JSON.parse(decodeUriComponent(consentCookie));
  let state = {};
  consentFields.forEach(function(field) {
    if (parsed[field]) state[field] = parsed[field];
  });
  updateConsentState(state);

  log('CMP Consent Handler: Synced consent states from cookie:', state);
}

// 3. Set the domain ID in the window object for the static banner
setInWindow('CH_DOMAIN_ID', domainId);

// 4. Inject the static banner only if the command is "default"
if (command === 'default') {
  injectScript(
    'https://pub-8eee64d8edc143d294dbd39fbc310f74.r2.dev/cookie-banner-static.js',
    data.gtmOnSuccess,
    data.gtmOnFailure
  );
} else {
  // 5. On user update, update Consent Mode and push audit event
  let settingsObject = {};
  consentFields.forEach(function(field) {
    if (data[field] === 'granted' || data[field] === 'denied') {
      settingsObject[field] = data[field];
    }
  });

  gtagSet({
    url_passthrough: data.url_passthrough || false,
    ads_data_redaction: data.ads_data_redaction || false
  });

  updateConsentState(settingsObject);

  data.gtmOnSuccess();
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "CH_DOMAIN_ID"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "url_passthrough"
              },
              {
                "type": 1,
                "string": "ads_data_redaction"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://pub-8eee64d8edc143d294dbd39fbc310f74.r2.dev/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "ch_cookie_consent"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 06/08/2025, 13:22:19


